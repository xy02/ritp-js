<button id="inc">inc</button>
<button id="dec">dec</button>
<div id="val"></div>
<script src="./dist/index.js"></script>
<script src="./node_modules/rxjs/bundles/rxjs.umd.min.js"></script>
<script>
    const { of, from, Observable, interval } = rxjs;
    const { startWith, catchError, delay, repeat, flatMap,map, tap, merge, shareReplay,share, take, groupBy, find, takeUntil,finalize } = rxjs.operators;
    
    const parseToChunk = str => new Observable(sub => {
        const b = new Blob([str])
        const fr = new FileReader()
        fr.readAsArrayBuffer(b)
        fr.onload = function () {
            const buf = new Uint8Array(fr.result)
            sub.next(buf)
            sub.complete()
        }
    })
    const conn = ritp_js.h5WsConnection('ws://localhost:8000/')
    const app = parseToChunk("app1").pipe(
        flatMap(info => ritp_js.init(conn,{ version: "0.1", info })),
        catchError(err => of().pipe(delay(2000))),
        repeat(),
        flatMap(peer => parseToChunk("request1").pipe(
            tap(info => {
                const stream = peer.stream({path:'acc',info})
                accRequester(stream)
            }),
        )),
    )
    const accRequester = ({sendableAmounts,outputBufs}) => outputBufs(
        sendableAmounts.pipe(
            flatMap(amount => {
                console.info('amount', amount)
                return of(new Uint8Array([amount]))
            }),
        )
    )
    app.subscribe()
</script>